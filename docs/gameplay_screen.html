<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>ê²Œì„ ì§„í–‰ í™”ë©´ - ì½©ì½©íŒ¥íŒ¥</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: #ffffff;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .screen-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        max-width: 480px;
        background-color: #ffffff;
        box-sizing: border-box;
        padding-bottom: env(safe-area-inset-bottom); /* ë…¸ì¹˜ ë””ìì¸ ëŒ€ì‘ */
        position: relative;
      }

      /* ìƒë‹¨ ì„¹ì…˜ - í”Œë ˆì´ì–´ ëª©ë¡ê³¼ ê²Œì„ ì˜ì—­ */
      .top-section {
        display: flex;
        flex: 1;
        overflow: hidden;
        border-bottom: 1px solid #eeeeee;
      }

      /* í•˜ë‹¨ ì„¹ì…˜ - ë²„íŠ¼ ì˜ì—­ */
      .bottom-section {
        width: 100%;
        padding: 12px 16px 16px 16px;
        background-color: #ffffff;
      }

      /* ì™¼ìª½ ì„¹ì…˜: í”Œë ˆì´ì–´ ëª©ë¡ */
      .player-list-section {
        width: 40%;
        border-right: 1px solid #eeeeee;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .player-list-title {
        font-size: 14px;
        font-weight: 600;
        color: #333333;
        text-align: center;
        padding: 16px 8px 12px 8px;
        border-bottom: 1px solid #f0f0f0;
      }

      .player-list {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow-y: auto;
        padding: 4px 0;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .player-list::-webkit-scrollbar {
        display: none;
      }

      .player-item {
        display: flex;
        align-items: center;
        padding: 10px 8px;
        margin: 3px 6px;
        border-radius: 8px;
        background-color: #f9f9f9;
        border: 1px solid transparent;
        transition: all 0.2s ease;
      }

      .player-item.current-turn {
        background-color: #e7f3ff;
        border-color: #c7e1ff;
      }

      .player-item.upcoming-turn {
        opacity: 0.7;
        background-color: #f0f0f0;
      }

      .player-item.finished-turn {
        background-color: #f0f0f0;
        opacity: 0.9;
      }

      .player-item.tie-player {
        background-color: #fff3cd;
        border-color: #ffecb5;
      }

      .player-item.inactive {
        opacity: 0.5;
      }

      .player-char {
        font-size: 1.6em;
        margin-right: 8px;
        width: 28px;
        text-align: center;
      }

      .player-info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .player-name {
        font-size: 13px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 2px;
      }

      .player-score {
        font-size: 15px;
        font-weight: 600;
        color: #007aff;
      }

      .player-score:empty::after {
        content: "-";
        color: #bbbbbb;
      }

      /* ì˜¤ë¥¸ìª½ ì„¹ì…˜: ê²Œì„ ì˜ì—­ */
      .game-section {
        width: 60%;
        padding: 16px 12px 10px 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }

      .game-mode-info {
        font-size: 12px;
        color: #666666;
        margin-bottom: 12px;
        background-color: #f5f5f5;
        padding: 6px 10px;
        border-radius: 6px;
        width: 100%;
        text-align: center;
      }

      /* ìŠ¤í†±ì›Œì¹˜ í‘œì‹œ */
      .stopwatch-display {
        font-size: 3.3em;
        font-weight: 300;
        color: #222222;
        margin: 5px 0 20px 0;
        font-family: "SF Mono", "Courier New", monospace;
        letter-spacing: 2px;
        text-align: center;
      }

      /* ì ìˆ˜íŒ í‘œì‹œ */
      .scoreboard {
        width: 100%;
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        margin-bottom: 10px;
      }

      .scoreboard-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding: 0 8px;
      }

      .scoreboard-row:last-child {
        margin-bottom: 0;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
      }

      .scoreboard-row .label {
        font-size: 14px;
        font-weight: 500;
        color: #555555;
        text-align: left;
      }

      .scoreboard-row span:not(.label) {
        font-size: 16px;
        font-weight: 600;
        color: #007aff;
        min-width: 30px;
        text-align: right;
      }

      .scoreboard-row:last-child span:not(.label) {
        color: #28a745;
      }

      .scoreboard-row span:not(.label):empty::after {
        content: "-";
        color: #bbbbbb;
      }

      /* ë²„íŠ¼ ì˜ì—­ */
      .button-area {
        width: 100%;
      }

      button {
        width: 100%;
        padding: 14px 0;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background-color: #007aff;
        color: white;
        transition: background-color 0.2s ease, transform 0.1s ease;
      }

      button:active {
        transform: scale(0.98);
      }

      button:disabled {
        background-color: #c7c7cc;
        opacity: 0.8;
      }

      #rematch-button {
        background-color: #ff9500;
      }

      /* ë²„íŠ¼ ê°€ì‹œì„± ê´€ë¦¬ */
      #start-button,
      #stop-button,
      #next-player-button,
      #results-button,
      #rematch-button {
        display: none;
      }

      .rematch-info {
        font-size: 13px;
        color: #ff9500;
        text-align: center;
        margin-top: 8px;
        display: none;
      }

      @media (max-height: 667px) {
        /* ì•„ì´í° 8 ì´í•˜ í¬ê¸° ëŒ€ì‘ */
        .stopwatch-display {
          font-size: 3em;
          margin: 0 0 15px 0;
        }

        .scoreboard {
          padding: 10px;
        }

        .player-item {
          padding: 8px 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="screen-container">
      <div class="top-section">
        <div class="player-list-section">
          <div class="player-list-title">í”Œë ˆì´ì–´ ìˆœì„œ</div>
          <div class="player-list">
            <!-- Player items populated by JS -->
          </div>
        </div>
        <div class="game-section">
          <div class="game-mode-info">
            ê²Œì„ ëª¨ë“œ: <span id="game-mode-text">íŒ¨ì ê²°ì • ëª¨ë“œ</span>
          </div>
          <div class="stopwatch-display">00:00</div>
          <div class="scoreboard">
            <div class="scoreboard-row">
              <span class="label">ì²«ë²ˆì§¸ :</span>
              <span id="digit1"></span>
            </div>
            <div class="scoreboard-row">
              <span class="label">ë‘ë²ˆì§¸ :</span>
              <span id="digit2"></span>
            </div>
            <div class="scoreboard-row">
              <span class="label">ê²°ê³¼ :</span>
              <span id="result"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="bottom-section">
        <div class="button-area">
          <button id="start-button">ì‹œì‘í•˜ê¸°</button>
          <button id="stop-button">ì •ì§€í•˜ê¸°</button>
          <button id="next-player-button">ë‹¤ìŒ í”Œë ˆì´ì–´</button>
          <button id="results-button">ê²°ê³¼ ë³´ê¸°</button>
          <button id="rematch-button">ì¬ê²½ê¸° ì‹œì‘</button>
        </div>
        <div class="rematch-info" id="rematch-info">
          ë™ì ì ì¬ê²½ê¸°ê°€ ì§„í–‰ë©ë‹ˆë‹¤
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- DOM Elements ---
        const playerListEl = document.querySelector(".player-list");
        const stopwatchDisplay = document.querySelector(".stopwatch-display");
        const digit1El = document.getElementById("digit1");
        const digit2El = document.getElementById("digit2");
        const resultEl = document.getElementById("result");
        const gameModeText = document.getElementById("game-mode-text");
        const startButton = document.getElementById("start-button");
        const stopButton = document.getElementById("stop-button");
        const nextPlayerButton = document.getElementById("next-player-button");
        const resultsButton = document.getElementById("results-button");
        const rematchButton = document.getElementById("rematch-button");
        const rematchInfo = document.getElementById("rematch-info");

        // --- Game Settings & State ---
        // ì´ì „ í™”ë©´ì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì • (ì‹¤ì œë¡œëŠ” URL íŒŒë¼ë¯¸í„°ë‚˜ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ í†µí•´ ê°€ì ¸ì˜´)
        // PRD: ì´ˆê¸°ê°’ì€ íŒ¨ì ê²°ì • ë°©ì‹, ì¬ê²½ê¸° ê°€ëŠ¥
        const gameSettings = {
          isWinnerMode: false, // false: íŒ¨ì ê²°ì •, true: ìŠ¹ì ê²°ì •
          allowRematch: true, // ë™ì ì ì¬ê²½ê¸° í—ˆìš© ì—¬ë¶€
        };

        // ê²Œì„ ëª¨ë“œ ì„¤ì • UI ì—…ë°ì´íŠ¸
        gameModeText.textContent = gameSettings.isWinnerMode
          ? "ìŠ¹ì ê²°ì • ëª¨ë“œ"
          : "íŒ¨ì ê²°ì • ëª¨ë“œ";

        // PRD Step Game Order: "ê²Œì„ ì‹œì‘ ì‹œ í”Œë ˆì´ì–´ ìˆœì„œê°€ ëœë¤ìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤."
        // Mockup Note: Using fixed order for simplicity. A real implementation would shuffle.
        const initialPlayers = [
          { id: 1, char: "ğŸ¶", name: "ê°•ì•„ì§€", score: null },
          { id: 2, char: "ğŸ±", name: "ê³ ì–‘ì´", score: null },
          { id: 3, char: "ğŸ¼", name: "íŒë‹¤", score: null },
          { id: 4, char: "ğŸ¦Š", name: "ì—¬ìš°", score: null },
          // Add more players if needed, up to 6-8 based on PRD
        ];

        let players = JSON.parse(JSON.stringify(initialPlayers)); // Deep copy for potential reset
        let currentPlayerIndex = 0;
        let currentStopwatchState = "idle";
        let tempDigit1 = null; // To store the first digit
        let stopwatchInterval = null; // Variable to hold the interval ID
        let startTime = 0; // Variable to store start time
        let elapsedTime = 0; // Variable to store elapsed time on stop
        let isRematch = false; // í˜„ì¬ ê²Œì„ì´ ì¬ê²½ê¸°ì¸ì§€ ì—¬ë¶€
        let tiePlayers = []; // ë™ì ì í”Œë ˆì´ì–´ ëª©ë¡
        let originalPlayers = []; // ì›ë˜ í”Œë ˆì´ì–´ ëª©ë¡ (ì¬ê²½ê¸° ì „ ìƒíƒœ ì €ì¥ìš©)

        // --- Helper Functions ---
        function assignPlayerStates() {
          players.forEach((player, index) => {
            if (isRematch) {
              // ì¬ê²½ê¸° ì‹œì—ëŠ” ë™ì ìë§Œ í™œì„±í™”, ë‚˜ë¨¸ì§€ëŠ” ë¹„í™œì„±í™”
              if (tiePlayers.some((p) => p.id === player.id)) {
                if (index === currentPlayerIndex && player.score === null) {
                  player.state = "current-turn";
                } else if (player.score !== null) {
                  player.state = "finished-turn tie-player";
                } else {
                  player.state = "upcoming-turn tie-player";
                }
              } else {
                player.state = "inactive";
              }
            } else {
              // ì¼ë°˜ ê²Œì„
              if (index === currentPlayerIndex && player.score === null) {
                player.state = "current-turn";
              } else if (player.score !== null) {
                player.state = "finished-turn";
              } else {
                player.state = "upcoming-turn";
              }
            }
          });
        }

        function renderPlayerList() {
          assignPlayerStates(); // Update states before rendering
          playerListEl.innerHTML = ""; // Clear list
          players.forEach((player) => {
            const item = document.createElement("div");
            item.classList.add("player-item");
            // í”Œë ˆì´ì–´ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€ (current-turn, upcoming-turn, finished-turn, tie-player, inactive ë“±)
            if (player.state) {
              player.state.split(" ").forEach((state) => {
                item.classList.add(state);
              });
            }
            item.dataset.playerId = player.id;

            item.innerHTML = `
              <span class="player-char">${player.char}</span>
              <div class="player-info">
                <span class="player-name">${player.name}</span>
                <span class="player-score">${player.score ?? ""}</span>
              </div>
            `;
            playerListEl.appendChild(item);
          });
        }

        function updateButtonVisibility() {
          // ëª¨ë“  ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          startButton.style.display = "none";
          stopButton.style.display = "none";
          nextPlayerButton.style.display = "none";
          resultsButton.style.display = "none";
          rematchButton.style.display = "none";
          rematchInfo.style.display = "none";

          switch (currentStopwatchState) {
            // ì²« ë²ˆì§¸ ì‹œì‘ ë˜ëŠ” ë‘ ë²ˆì§¸ ì‹œì‘ ì „
            case "idle":
            case "stopped1":
              startButton.style.display = "block";
              break;
            // ì‹¤í–‰ ì¤‘
            case "running1":
            case "running2":
              stopButton.style.display = "block";
              break;
            // ë‘ ë²ˆì§¸ ì •ì§€ í›„
            case "stopped2":
              if (
                currentPlayerIndex < players.length - 1 &&
                !checkForImmediateGameEnd()
              ) {
                // ë‹¤ìŒ í”Œë ˆì´ì–´ ìˆìŒ
                nextPlayerButton.style.display = "block";
              } else {
                // ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ ë˜ëŠ” ëª¨ë“  ë™ì ìì˜ í„´ì´ ëë‚¬ì„ ë•Œ
                if (isAllPlayersFinished()) {
                  // ë™ì ì ì²˜ë¦¬
                  const tiedPlayers = findTiedPlayers();
                  if (
                    tiedPlayers.length > 1 &&
                    gameSettings.allowRematch &&
                    !isRematch
                  ) {
                    // ë™ì ìê°€ ìˆê³  ì¬ê²½ê¸° ê°€ëŠ¥í•œ ê²½ìš°
                    rematchButton.style.display = "block";
                    rematchInfo.style.display = "block";
                  } else {
                    // ë™ì ìê°€ ì—†ê±°ë‚˜ ì¬ê²½ê¸° ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
                    resultsButton.style.display = "block";
                  }
                } else {
                  // ì•„ì§ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ë§ˆì¹˜ì§€ ì•Šì•˜ìŒ (ì¬ê²½ê¸° ì¤‘)
                  nextPlayerButton.style.display = "block";
                }
              }
              break;
          }
        }

        function formatTime(timeMs) {
          // ì´ˆ ê³„ì‚° (0-59)
          const seconds = Math.floor(timeMs / 1000) % 60;
          // ë°€ë¦¬ì´ˆëŠ” 00-99 ì‚¬ì´ ë‘ ìë¦¬ìˆ˜ë¡œ í‘œì‹œ
          const milliseconds = Math.floor((timeMs % 1000) / 10);

          // ë‘ ìë¦¬ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì˜ˆ: 05:78)
          return `${String(seconds).padStart(2, "0")}:${String(
            milliseconds
          ).padStart(2, "0")}`;
        }

        function resetGameAreaForNextPlayer() {
          if (stopwatchInterval) {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
          }
          startTime = 0;
          elapsedTime = 0;
          stopwatchDisplay.textContent = "00:00";
          digit1El.textContent = "";
          digit2El.textContent = "";
          resultEl.textContent = "";
          tempDigit1 = null;
          currentStopwatchState = "idle";
          updateButtonVisibility();
        }

        // ë°€ë¦¬ì´ˆ ë§ˆì§€ë§‰ ìë¦¬ ìˆ«ì ê°€ì ¸ì˜¤ê¸° (ì ìˆ˜ ê³„ì‚°ìš©)
        function getLastMillisecondDigit(timeMs) {
          // ë°€ë¦¬ì´ˆ ê°’ ì–»ê¸° (0-999)
          const milliseconds = timeMs % 1000;
          // ë°€ë¦¬ì´ˆì˜ ë§ˆì§€ë§‰ ìë¦¬ ìˆ«ì ì–»ê¸° (0-9)
          return Math.floor((milliseconds % 100) / 10);
        }

        // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ë§ˆì³¤ëŠ”ì§€ í™•ì¸
        function isAllPlayersFinished() {
          if (isRematch) {
            // ì¬ê²½ê¸° ì¤‘ì¸ ê²½ìš°ëŠ” tiePlayers ë°°ì—´ì˜ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ë§ˆì³¤ëŠ”ì§€ í™•ì¸
            return tiePlayers.every((p) => {
              const player = players.find((player) => player.id === p.id);
              return player && player.score !== null;
            });
          } else {
            // ì¼ë°˜ ê²Œì„ì˜ ê²½ìš° ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ë§ˆì³¤ëŠ”ì§€ í™•ì¸
            return players.every((p) => p.score !== null);
          }
        }

        // ë™ì ì ì°¾ê¸°
        function findTiedPlayers() {
          if (players.some((p) => p.score === null)) {
            // ì•„ì§ ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ì„ ë§ˆì¹˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
            return [];
          }

          // ì„¤ì •ì— ë”°ë¼ ìµœê³  ì ìˆ˜ ë˜ëŠ” ìµœì € ì ìˆ˜ ì°¾ê¸°
          let targetScore;
          let tiedPlayers = [];

          if (gameSettings.isWinnerMode) {
            // ìŠ¹ì ê²°ì • ëª¨ë“œ - ìµœê³  ì ìˆ˜ ì°¾ê¸°
            targetScore = Math.max(...players.map((p) => p.score));
            tiedPlayers = players.filter((p) => p.score === targetScore);
          } else {
            // íŒ¨ì ê²°ì • ëª¨ë“œ - ìµœì € ì ìˆ˜ ì°¾ê¸°
            targetScore = Math.min(...players.map((p) => p.score));
            tiedPlayers = players.filter((p) => p.score === targetScore);
          }

          return tiedPlayers;
        }

        // ì¦‰ì‹œ ê²Œì„ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ (ì¬ê²½ê¸° ì¤‘ ë™ì ìê°€ 1ëª…ë§Œ ë‚¨ì€ ê²½ìš°)
        function checkForImmediateGameEnd() {
          if (!isRematch) return false;

          // ì ìˆ˜ê°€ ìˆëŠ” í”Œë ˆì´ì–´ í•„í„°ë§
          const playersWithScore = players.filter(
            (p) => tiePlayers.some((tp) => tp.id === p.id) && p.score !== null
          );

          if (playersWithScore.length < 2) return false;

          // ì ìˆ˜ë¡œ ì •ë ¬
          const sortedPlayers = [...playersWithScore].sort((a, b) => {
            if (gameSettings.isWinnerMode) {
              return b.score - a.score; // ë‚´ë¦¼ì°¨ìˆœ
            } else {
              return a.score - b.score; // ì˜¤ë¦„ì°¨ìˆœ
            }
          });

          // 1ë“±(ìŠ¹ì ëª¨ë“œ) ë˜ëŠ” ê¼´ë“±(íŒ¨ì ëª¨ë“œ)ì´ ë‹¨ë…ìœ¼ë¡œ ê²°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
          const topPlayer = sortedPlayers[0];
          const secondPlayer = sortedPlayers[1];

          return topPlayer.score !== secondPlayer.score;
        }

        // ì¬ê²½ê¸° ì„¸íŒ…
        function setupRematch() {
          // ì›ë˜ í”Œë ˆì´ì–´ ëª©ë¡ ë³´ê´€
          originalPlayers = JSON.parse(JSON.stringify(players));

          // ë™ì ì í•„í„°ë§
          tiePlayers = findTiedPlayers();

          // ë™ì ìë“¤ì˜ ì ìˆ˜ ì´ˆê¸°í™”
          players.forEach((p) => {
            if (tiePlayers.some((tp) => tp.id === p.id)) {
              p.score = null;
            }
          });

          // ì²« ë²ˆì§¸ ë™ì ìë¶€í„° ì‹œì‘
          currentPlayerIndex = players.findIndex((p) =>
            tiePlayers.some((tp) => tp.id === p.id)
          );
          isRematch = true;

          // ê²Œì„ ì˜ì—­ ì´ˆê¸°í™”
          resetGameAreaForNextPlayer();
          renderPlayerList();
        }

        // --- Event Listeners ---
        startButton.addEventListener("click", () => {
          // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì œê±°
          if (stopwatchInterval) {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
          }

          if (currentStopwatchState === "idle") {
            // ì²« ë²ˆì§¸ ì‹œì‘
            currentStopwatchState = "running1";
            startTime = Date.now();
            elapsedTime = 0;
          } else if (currentStopwatchState === "stopped1") {
            // ë‘ ë²ˆì§¸ ì‹œì‘
            currentStopwatchState = "running2";
            startTime = Date.now(); // ìƒˆë¡œìš´ ì‹œì‘ ì‹œê°„ ì„¤ì •
            elapsedTime = 0; // ë‘ ë²ˆì§¸ ì¸¡ì •ì€ 0ë¶€í„° ì‹œì‘
          }

          // ìŠ¤í†±ì›Œì¹˜ í‘œì‹œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì¸í„°ë²Œ ì„¤ì •
          stopwatchInterval = setInterval(() => {
            const now = Date.now();
            const currentElapsed = now - startTime;
            stopwatchDisplay.textContent = formatTime(currentElapsed);
          }, 20); // ë¶€ë“œëŸ¬ìš´ ë°€ë¦¬ì´ˆ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì§§ì€ ê°„ê²© ì„¤ì •

          updateButtonVisibility();
        });

        stopButton.addEventListener("click", () => {
          // ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ë©ˆì¶¤
          if (stopwatchInterval) {
            clearInterval(stopwatchInterval);
            stopwatchInterval = null;
          }

          // í˜„ì¬ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
          const stopTime = Date.now();
          elapsedTime = stopTime - startTime;

          // ìµœì¢… ì‹œê°„ í‘œì‹œ
          stopwatchDisplay.textContent = formatTime(elapsedTime);

          // ë§ˆì§€ë§‰ ë°€ë¦¬ì´ˆ ìë¦¬ ìˆ«ì ê°€ì ¸ì˜¤ê¸° (0-9)
          const lastDigit = getLastMillisecondDigit(elapsedTime);

          if (currentStopwatchState === "running1") {
            // ì²« ë²ˆì§¸ ì •ì§€
            tempDigit1 = lastDigit;
            digit1El.textContent = tempDigit1;
            currentStopwatchState = "stopped1";
          } else if (currentStopwatchState === "running2") {
            // ë‘ ë²ˆì§¸ ì •ì§€
            const digit2 = lastDigit;
            digit2El.textContent = digit2;

            // ì ìˆ˜ ê³„ì‚°
            const score = tempDigit1 * digit2;
            // ê²°ê³¼ í‘œì‹œ í˜•ì‹ ë³€ê²½ - "ì²«ë²ˆì§¸ x ë‘ë²ˆì§¸ = ê²°ê³¼" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
            resultEl.textContent = `${tempDigit1} x ${digit2} = ${score}`;

            // í”Œë ˆì´ì–´ ì ìˆ˜ ì—…ë°ì´íŠ¸
            players[currentPlayerIndex].score = score;
            currentStopwatchState = "stopped2";
            renderPlayerList();
          }

          updateButtonVisibility();
        });

        nextPlayerButton.addEventListener("click", () => {
          // ë‹¤ìŒ í”Œë ˆì´ì–´ë¥¼ ì°¾ê¸° ìœ„í•œ ë³€ìˆ˜
          let nextPlayerFound = false;
          let initialIndex = currentPlayerIndex; // ì´ˆê¸° ì¸ë±ìŠ¤ ì €ì¥

          // í˜„ì¬ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘í•´ì„œ ë‹¤ìŒ í”Œë ˆì´ì–´ ì°¾ê¸°
          while (!nextPlayerFound) {
            currentPlayerIndex++;

            // ë°°ì—´ ë²”ìœ„ë¥¼ ë„˜ì–´ê°€ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘
            if (currentPlayerIndex >= players.length) {
              currentPlayerIndex = 0;
            }

            // ì›ë˜ ìœ„ì¹˜ë¡œ ëŒì•„ì™”ìœ¼ë©´ ëª¨ë“  í”Œë ˆì´ì–´ íƒìƒ‰ ì™„ë£Œ
            if (currentPlayerIndex === initialIndex) {
              break;
            }

            const currentPlayer = players[currentPlayerIndex];

            // ì¬ê²½ê¸° ì¤‘ì´ë©´ ë™ì ìë§Œ ê³ ë ¤
            if (isRematch) {
              if (
                tiePlayers.some((p) => p.id === currentPlayer.id) &&
                currentPlayer.score === null
              ) {
                nextPlayerFound = true;
              }
            } else {
              // ì¼ë°˜ ê²Œì„ì—ì„œëŠ” ì ìˆ˜ê°€ ì—†ëŠ” í”Œë ˆì´ì–´ ì„ íƒ
              if (currentPlayer.score === null) {
                nextPlayerFound = true;
              }
            }
          }

          renderPlayerList(); // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ (í˜„ì¬, ì˜ˆì •, ì™„ë£Œ)
          resetGameAreaForNextPlayer(); // ìƒˆ í”Œë ˆì´ì–´ë¥¼ ìœ„í•œ ì˜¤ë¥¸ìª½ íŒ¨ë„ ì´ˆê¸°í™”
        });

        resultsButton.addEventListener("click", () => {
          // ê²°ê³¼ íŒì •
          let resultMessage = "";
          let tiedPlayers = findTiedPlayers();

          if (gameSettings.isWinnerMode) {
            // ìŠ¹ì ê²°ì • ëª¨ë“œ
            const maxScore = Math.max(...players.map((p) => p.score));
            const winners = players.filter((p) => p.score === maxScore);

            if (winners.length === 1) {
              resultMessage = `ê²Œì„ ì¢…ë£Œ! ìµœê³  ì ìˆ˜ëŠ” ${winners[0].name} (${winners[0].score}ì ) ì…ë‹ˆë‹¤!`;
            } else {
              const winnerNames = winners.map((p) => p.name).join(", ");
              resultMessage = `ê²Œì„ ì¢…ë£Œ! ê³µë™ ìš°ìŠ¹: ${winnerNames} (${maxScore}ì )`;
            }
          } else {
            // íŒ¨ì ê²°ì • ëª¨ë“œ
            const minScore = Math.min(...players.map((p) => p.score));
            const losers = players.filter((p) => p.score === minScore);

            if (losers.length === 1) {
              resultMessage = `ê²Œì„ ì¢…ë£Œ! ìµœì € ì ìˆ˜ëŠ” ${losers[0].name} (${losers[0].score}ì ) ì…ë‹ˆë‹¤!`;
            } else {
              const loserNames = losers.map((p) => p.name).join(", ");
              resultMessage = `ê²Œì„ ì¢…ë£Œ! ê³µë™ ê¼´ë“±: ${loserNames} (${minScore}ì )`;
            }
          }

          alert(`${resultMessage}\n(ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤)`);
          // TODO: Navigate to Result Screen (PRD 4)
        });

        rematchButton.addEventListener("click", () => {
          setupRematch();
          updateButtonVisibility();
        });

        // --- Initial Setup ---
        renderPlayerList();
        updateButtonVisibility();
      });
    </script>
  </body>
</html>
